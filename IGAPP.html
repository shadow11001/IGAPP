<!DOCTYPE html>
<!-- Version: 1.0.0 -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Walmart Digital Assets QA Checklist and Notes Application">
    <title>Walmart Digital Assets - QA Checklist</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            transition: background-color 0.3s, color 0.3s;
        }

        body.light-mode {
            background-color: #ffffff;
            color: #000000;
        }

        body.dark-mode {
            background-color: #1a1a1a;
            color: #ffffff;
        }

        .form-container {
            max-width: 1200px;
            width: 90%;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid;
            border-radius: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            transition: background-color 0.3s, border-color 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        @media (max-width: 768px) {
            .form-container {
                width: 95%;
                margin: 10px auto;
                padding: 15px;
                gap: 15px;
            }
            .form-section, .qa-container {
                min-width: 100%;
            }
        }

        body.light-mode .form-container {
            background: #f9f9f9;
            border-color: #ccc;
        }

        body.dark-mode .form-container {
            background: #2c2c2c;
            border-color: #555;
        }

        .form-section {
            flex: 1;
            min-width: 250px;
        }

        .qa-container {
            flex: 0.5;
            min-width: 200px;
        }

        textarea, input, select {
            width: 100%;
            margin-top: 10px;
            padding: 5px;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        body.light-mode textarea,
        body.light-mode input,
        body.light-mode select {
            background-color: #ffffff;
            color: #000000;
            border: 1px solid #ccc;
        }

        body.dark-mode textarea,
        body.dark-mode input,
        body.dark-mode select {
            background-color: #333;
            color: #ffffff;
            border: 1px solid #666;
        }

        textarea {
            height: 70px;
        }

        button {
            margin-top: 10px;
            margin-right: 10px;
            padding: 8px 16px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            min-height: 36px;
        }

        button:focus {
            outline: 2px solid #007bff;
            outline-offset: 2px;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .success-feedback {
            background-color: #28a745 !important;
            transform: scale(0.98);
        }

        .error-feedback {
            background-color: #dc3545 !important;
            transform: scale(0.98);
        }

        body.light-mode button {
            background-color: #007bff;
            color: #ffffff;
        }

        body.dark-mode button {
            background-color: #555;
            color: #ffffff;
        }

        body.light-mode button:hover {
            background-color: #0056b3;
        }

        body.dark-mode button:hover {
            background-color: #777;
        }

        .qa-container p {
            margin-bottom: 5px;
        }

        .theme-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.5em;
        }

        .notification {
            position: fixed;
            top: 60px;
            right: 20px;
            padding: 12px 16px;
            border-radius: 4px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background-color: #28a745;
        }

        .notification.error {
            background-color: #dc3545;
        }

        .loading {
            position: relative;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .danger-button {
            background-color: #dc3545 !important;
        }

        .danger-button:hover {
            background-color: #c82333 !important;
        }

        small {
            display: block;
            margin-top: 4px;
            font-size: 12px;
            opacity: 0.7;
        }
    </style>
</head>
<body class="light-mode">
    <button class="theme-toggle" aria-label="Toggle between light and dark mode" onclick="toggleTheme()" id="theme-toggle-btn" tabindex="0">
        <i class="fas fa-sun" id="theme-toggle-icon" aria-hidden="true"></i>
    </button>

    <div class="form-container">
        <!-- QA Checklist on the Left -->
        <div class="qa-container">
            <h3>QA Checklist</h3>
            <p>✔ Thanks for calling Walmart Digital Assets, where we're always happy to help! My name is [NAME], can I please have your name site and work order number from which you are calling? </p>
            <p>✔ Repeat site and workorder back to the tech if no work order is provided say "you said site number is xxxx and no workorder correct"</p>
            <p>✔ Fill Dead air with small talk or talking yourself through the call.</p>
            <p>✔ Thank you for calling walmart digital assets stay on the line for a brief survey</p>
            <p>✔ Did you put the store number in VCC?</p>
            <p>✔ Did you tag HVAC, refrigeration, lighting, or comms in VCC?</p>
            <p>✔ Did you tag the proper EMS in VCC?</p>
            <p>✔ Did you notate service channel if a work order was provided?</p>
        </div>

        <!-- Form Fields on the Right -->
        <div class="form-section">
            <h1>Notes</h1>

            <label for="history">View Previous Notes:</label>
            <select id="history" onchange="restoreNotes()" aria-describedby="history-help">
                <option value="">-- Select Previous Notes --</option>
            </select>
            <small id="history-help" class="sr-only">Select from previously saved notes from the last 7 days</small>

            <label for="tech-name">Technician Name:</label>
            <input type="text" id="tech-name" placeholder="Enter technician name" aria-required="false" autocomplete="name">

            <label for="store-number">Store Number:</label>
            <input type="number" id="store-number" placeholder="Enter store number" aria-required="false" inputmode="numeric">

            <label for="work-order">Work Order Number:</label>
            <input type="text" id="work-order" placeholder="Enter work order number" aria-required="false">

            <label for="autofill">Select a DAE:</label>
            <select id="autofill" onchange="updateNotes()" aria-describedby="autofill-help">
                <option value="">-- Select an Option --</option>
                <option value="Help Desk Post">Help Desk Post</option>
                <option value="Condenser and Compressor Staging Changes">Condenser and Compressor Staging Changes</option>
                <option value="Changes to Rack Suction Settings">Changes to Rack Suction Settings</option>
                <option value="Reporting Issues with IoT">Reporting Issues with IoT</option>
                <option value="Setting MAC Addresses">Setting MAC Addresses for Controller Replacements</option>
                <option value="Controller COMM Loss">Controller COMM Loss Related to Network & Cabling</option>
                <option value="Changing Board Points">Changing Board Points in Danfoss or CPC</option>
                <option value="Carel BOSS Support">Calls, alarms, or emails related to Carel BOSS controllers</option>
                <option value="Novar Download Failures">Novar Downloads that Failed After Second Attempt</option>
                <option value="Danfoss Downloads">Downloads for any Danfoss controller</option>
                <option value="Manager Escalations">Manager Escalations</option>
                <option value="Program Change Request">Program Change Request</option>
                <option value="RTU Fans Mode">Taking RTU Fans Out Of Continuous Mode</option>
                <option value="Parameter Deviation">Parameter Deviation Request</option>
                <option value="Swap Work Order">Swap Work Order</option>
                <option value="Mastermind Work Order">Mastermind Work Order</option>
            </select>

            <label for="dropdown-notes">DAE:</label>
            <textarea id="dropdown-notes" placeholder="Selecting a dropdown will load a template here. If this box is not empty, you will be asked to confirm before overwriting." aria-describedby="dae-help"></textarea>
            <small id="dae-help" class="sr-only">Template text for Digital Asset Expert procedures</small>
            <small id="autofill-help" class="sr-only">Selecting an option will populate the DAE textarea with template text</small>
            <button onclick="copyToClipboard(event, 'dropdown-notes')" aria-describedby="copy-dae-help">Copy DAE</button>
            <small id="copy-dae-help" class="sr-only">Copy DAE template text to clipboard</small>

            <label for="notes">Your Call Notes:</label>
            <textarea id="notes" placeholder="Enter your call notes here..." aria-describedby="notes-help"></textarea>
            <small id="notes-help" class="sr-only">Enter additional notes about the call. This will be combined with technician information when copied.</small>
            <button onclick="copyAdditionalNotes(event)" aria-describedby="copy-notes-help">Copy Notes</button>
            <small id="copy-notes-help" class="sr-only">Copy all form data including technician info and notes to clipboard</small>
            <button onclick="clearFormFields()" aria-describedby="clear-form-help">Clear Form</button>
            <small id="clear-form-help" class="sr-only">Clear all form fields but keep history</small>
            <button onclick="clearForm()" aria-describedby="clear-all-help" class="danger-button">Clear Everything</button>
            <small id="clear-all-help" class="sr-only">Clear all form fields and delete all saved history</small>
        </div>
    </div>

<!-- Templates are now managed in JavaScript for maintainability -->

    <script>
        // Global state management
        const AppState = {
            autoSaveTimer: null,
            lastSavedData: null
        };

        // Utility functions
        function showNotification(message, type = 'success', duration = 3000) {
            // Remove existing notifications
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.setAttribute('role', 'alert');
            notification.setAttribute('aria-live', 'polite');
            
            document.body.appendChild(notification);
            
            // Trigger animation
            setTimeout(() => notification.classList.add('show'), 100);
            
            // Auto remove
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                }
            }, duration);
        }

        function addButtonFeedback(button, type = 'success') {
            const originalClass = button.className;
            button.classList.add(`${type}-feedback`);
            setTimeout(() => {
                button.className = originalClass;
            }, 200);
        }

        function validateInput(value, type = 'text') {
            if (type === 'storeNumber') {
                return /^\d+$/.test(value) || value === '';
            }
            return true;
        }

        // Enhanced theme management
        function toggleTheme() {
            try {
                const body = document.body;
                const button = document.getElementById('theme-toggle-btn');
                
                body.classList.toggle('light-mode');
                body.classList.toggle('dark-mode');
                const isDark = body.classList.contains('dark-mode');
                
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                updateThemeIcon(isDark);
                
                // Update button aria-label
                button.setAttribute('aria-label', 
                    isDark ? 'Switch to light mode' : 'Switch to dark mode'
                );
                
                showNotification(`Switched to ${isDark ? 'dark' : 'light'} mode`, 'success', 1500);
            } catch (error) {
                console.error('Theme toggle failed:', error);
                showNotification('Failed to toggle theme', 'error');
            }
        }

        function updateThemeIcon(isDark) {
            const icon = document.getElementById('theme-toggle-icon');
            if (icon) {
                if (isDark) {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                } else {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                }
            }
        }

        // Enhanced history management with better error handling
        function saveNotesHistory() {
            try {
                const formData = getFormData();
                
                if (!hasValidData(formData)) {
                    return false;
                }

                const noteEntry = {
                    ...formData,
                    timestamp: Date.now(),
                    id: generateId()
                };

                let history = getNotesHistory();
                history = cleanOldEntries(history);
                
                // Prevent duplicate entries
                const isDuplicate = history.some(entry => 
                    entry.techName === formData.techName &&
                    entry.storeNumber === formData.storeNumber &&
                    entry.workOrder === formData.workOrder &&
                    Math.abs(entry.timestamp - noteEntry.timestamp) < 60000 // Within 1 minute
                );
                
                if (!isDuplicate) {
                    history.push(noteEntry);
                    localStorage.setItem('notesHistory', JSON.stringify(history));
                    updateHistoryDropdown();
                }
                
                return true;
            } catch (error) {
                console.error('Failed to save notes history:', error);
                showNotification('Failed to save to history', 'error');
                return false;
            }
        }

        function getFormData() {
            return {
                techName: document.getElementById('tech-name').value.trim(),
                storeNumber: document.getElementById('store-number').value.trim(),
                workOrder: document.getElementById('work-order').value.trim(),
                notes: document.getElementById('notes').value.trim()
            };
        }

        function hasValidData(data) {
            return Object.values(data).some(value => value.length > 0);
        }

        function getNotesHistory() {
            try {
                return JSON.parse(localStorage.getItem('notesHistory') || '[]');
            } catch (error) {
                console.error('Failed to parse notes history:', error);
                return [];
            }
        }

        function cleanOldEntries(history) {
            const sevenDaysInMs = 7 * 24 * 60 * 60 * 1000;
            return history.filter(entry => Date.now() - entry.timestamp <= sevenDaysInMs);
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function updateHistoryDropdown() {
            try {
                const history = getNotesHistory();
                const historySelect = document.getElementById('history');
                
                if (!historySelect) return;
                
                historySelect.innerHTML = '<option value="">-- Select Previous Notes --</option>';
                
                // Sort by timestamp (newest first)
                const sortedHistory = history.sort((a, b) => b.timestamp - a.timestamp);
                
                sortedHistory.forEach((entry) => {
                    const date = new Date(entry.timestamp).toLocaleString();
                    // Truncate techName and storeNumber for better readability
                    let techName = entry.techName || 'No Name';
                    let storeNumber = entry.storeNumber || 'N/A';
                    if (techName.length > 18) techName = techName.substring(0, 15) + '...';
                    if (storeNumber.length > 10) storeNumber = storeNumber.substring(0, 10) + '...';
                    const label = `${date} - ${techName} (Store: ${storeNumber})`;
                    const option = document.createElement('option');
                    option.value = entry.id;
                    option.textContent = label;
                    historySelect.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to update history dropdown:', error);
            }
        }

        function restoreNotes() {
            try {
                const historySelect = document.getElementById('history');
                const selectedId = historySelect.value;
                if (!selectedId) return;

                const history = getNotesHistory();
                const entry = history.find(e => e.id === selectedId);
                
                if (entry) {
                    document.getElementById('tech-name').value = entry.techName || '';
                    document.getElementById('store-number').value = entry.storeNumber || '';
                    document.getElementById('work-order').value = entry.workOrder || '';
                    document.getElementById('notes').value = entry.notes || '';
                    
                    showNotification('Notes restored successfully', 'success', 2000);
                    
                    // Auto-save after restore
                    scheduleAutoSave();
                }
            } catch (error) {
                console.error('Failed to restore notes:', error);
                showNotification('Failed to restore notes', 'error');
            }
        }

        // Helper for DAE notes overwrite confirmation
        function shouldOverwriteDAENotes(notesBox) {
            // Returns true if it's safe to overwrite, or user confirms overwrite
            if (!notesBox.dataset.userEdited || notesBox.dataset.userEdited === 'false' || !notesBox.value.trim()) {
                return true;
            }
            return confirm('This will overwrite your current DAE notes. Continue?');
        }

                // DAE Templates managed in JavaScript for maintainability
                const DAE_TEMPLATES = {
                    "Help Desk Post": `Store # 
        EMS - 
        WO# - 
        Issue - 
        What have you done? 
        Wiki Link Used - 
        Any screenshots of issue.:`,
        
                    "Condenser and Compressor Staging Changes": `Technician first and last name:
        Technician cell phone number:
        Technician email address:
        Store number:
        WO:
        Rack (LTA, MTB etc.):
        EMS system (Novar, Opus, CPC, Danfoss etc.):
        What the technician has requested and the reason for the request:`,
        
                    "Changes to Rack Suction Settings": `Technician first and last name:
        Technician cell phone number:
        Technician email address:
        Store number:
        WO:
        Rack (LTA, MTB etc.):
        EMS system (Novar, Opus, CPC, Danfoss etc.):
        What the technician has requested and the reason for the request:`,
        
                    "Reporting Issues with IoT": `Technician first and last name:
        Technician cell phone number:
        Technician email address:
        Store number:
        WO:
        Detailed error description:
        Screenshots of the error in IoT as well as any supporting screenshots from the EMS system. Paste them into a Word doc and attach it to the work order when you create it.:`,
        
                    "Setting MAC Addresses": `Technician first and last name:
        Technician cell phone number:
        Technician email address:
        Store number:
        WO:
        New device type and position (For example, Novar ES1 on rack LTB or Emerson E2E on HVAC):
        MAC address of the new device (must be 12 characters):
        Old MAC address:`,
        
                    "Controller COMM Loss": `Technician first and last name:
        Technician cell phone number:
        Technician email address:
        Store number:
        WO:
        EMS system (Novar, Opus, CPC, Danfoss etc.):
        Is the ethernet cable plugged into the device, yes or no?:
        Controller type (Novar EP2, Emerson E2E, Danfoss AK255 etc.):
        What system it controls (HVAC, Rack A, Rack B…etc.):
        Has the controller been power cycled, yes or no?:
        Is the controller functioning normally per the technician? If not, please provide details.: 
        MAC address (must be 12 characters):
        The switch and Port controller goes to (if tech can provide):`,
        
                    "Changing Board Points": `Technician first and last name:
        Technician cell phone number:
        Technician email address:
        Store number:
        WO:
        Rack (LTA, MTB etc.):
        Current module address and point number.:
        New module address and point number.:`,
        
                    "Carel BOSS Support": `Technician first and last name:
        Technician cell phone number:
        Technician email address:
        Store number:
        WO:
        Rack (LTA, MTB etc.):
        Detailed description of technician request OR
        If an alarm, include a screenshot of the alarm in IoT.:`,
        
                    "Novar Download Failures": `Technician first and last name:
        Technician cell phone number:
        Technician email address:
        Store number:
        WO:
        Type of download needed (version, main, comm, etc.):
        What system it controls (HVAC, Rack A, Rack B…etc.):
        Description of controller behavior or error messages received. Paste screenshots of error messages into a Word document and attach it to the work order as you create it.:`,
        
                    "Danfoss Downloads": `Technician first and last name:
        Technician cell phone number:
        Technician email address:
        Store number:
        WO:
        What system it controls (HVAC, Rack A, Rack B…etc.):
        Description of what prompted the download request (Controller change out, controller software failure, etc.):
        MAC address (must be 12 characters):`,
        
                    "Manager Escalations": `Name of the manager or team lead authorizing the escalation:
        Technician first and last name:
        Technician cell phone number:
        Technician email address:
        Store number:
        WO:
        Detailed description of the issue:
        What actions Contact Center agents have taken so far:
        Any supporting screenshots of EMS systems or other documentation. Paste screenshots of error messages into a Word document and attach it to the work order as you create it.:`,
        
                    "Program Change Request": `Technician first and last name:
        Technician cell phone number:
        Technician email address:
        Store number:
        WO:
        EMS system (Novar, Opus, CPC, Danfoss etc.):
        What the technician has requested and the reason for the request:
        A screenshot of the module in the EMS system.:`,
        
                    "RTU Fans Mode": `Technician first and last name:
        Technician cell phone number:
        Technician email address:
        Store number:
        WO:
        EMS system (Novar, Opus, CPC, Danfoss etc.):
        What RTU fan(s) the technician has requested to turn off and the reason for the request.:`,
        
                    "Parameter Deviation": `Name of the manager or team lead authorizing the escalation:
        Technician first and last name:
        Technician cell phone number:
        Technician email address:
        Store number:
        WO:
        Detailed description of request:
        Current setpoint and requested setpoint:
        Screenshots of setpoint in EMS system and of the Parameter Cutsheet.:`,
        
                    "Swap Work Order": `Swap Workorder Notes Show: (Enter the notes from the email).
        Please email acserv@wal-mart.com when service is complete. Please provide notes regarding work done along with on/off site dates and times. You may also contact Alarm Central at 479-273-4600, options 1 and 4 between the hours of 7AM-7PM CST Mon-Fri:`,
        
                    "Mastermind Work Order": `Mastermind Report Notes Show: (Enter the notes from the work order attachment that is in all caps).
        Please email acserv@wal-mart.com when service is complete. Please provide notes regarding work done along with on/off site dates and times. You may also contact Alarm Central at 479-273-4600, options 1 and 4 between the hours of 7AM-7PM CST Mon-Fri:`
                };
        
                // Enhanced notes updating with validation
        function updateNotes() {
            try {
                const selectedOption = document.getElementById('autofill').value;
                if (!selectedOption) return;

                const notesBox = document.getElementById('dropdown-notes');
                const selectedText = DAE_TEMPLATES[selectedOption] || '';

                if (!selectedText) {
                    showNotification('Template not found', 'error');
                    return;
                }

                // Use helper for overwrite confirmation
                if (shouldOverwriteDAENotes(notesBox)) {
                    notesBox.value = selectedText;
                    notesBox.dataset.userEdited = 'false';
                    showNotification('Template loaded', 'success', 1500);
                }
            } catch (error) {
                console.error('Failed to update notes:', error);
                showNotification('Failed to load template', 'error');
            }
        }

        // Enhanced clipboard functionality
        async function copyToClipboard(event, elementId) {
            const button = event.target;
            try {
                const element = document.getElementById(elementId);
                
                if (!element) {
                    throw new Error('Element not found');
                }
                
                const textToCopy = element.value.trim();
                
                if (!textToCopy) {
                    showNotification('Nothing to copy', 'error');
                    return;
                }
                
                button.disabled = true;
                button.classList.add('loading');
                
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(textToCopy);
                } else {
                    // Fallback for older browsers
                    element.select();
                    document.execCommand('copy');
                }
                
                addButtonFeedback(button, 'success');
                showNotification('Copied to clipboard!', 'success');
                
            } catch (error) {
                console.error('Copy failed:', error);
                addButtonFeedback(button, 'error');
                showNotification('Failed to copy to clipboard', 'error');
            } finally {
                button.disabled = false;
                button.classList.remove('loading');
            }
        }

        async function copyAdditionalNotes(event) {
            try {
                const button = event.target;
                const formData = getFormData();
                
                const copiedText = [];
                if (formData.techName) copiedText.push(`Technician Name: ${formData.techName}`);
                if (formData.storeNumber) copiedText.push(`Store Number: ${formData.storeNumber}`);
                if (formData.workOrder) copiedText.push(`Work Order Number: ${formData.workOrder}`);
                if (formData.notes) copiedText.push(formData.notes);

                if (copiedText.length === 0) {
                    showNotification('No data to copy', 'error');
                    button.disabled = false;
                    button.classList.remove('loading');
                    return;
                }
                
                button.disabled = true;
                button.classList.add('loading');
                const success = saveNotesHistory();
                
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(copiedText.join('\n'));
                } else {
                    // Fallback
                    const tempTextarea = document.createElement('textarea');
                    tempTextarea.value = copiedText.join('\n');
                    document.body.appendChild(tempTextarea);
                    tempTextarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempTextarea);
                }
                
                addButtonFeedback(button, 'success');
                showNotification(
                    success ? 'Copied and saved to history!' : 'Copied successfully!', 
                    'success'
                );
                
            } catch (error) {
                console.error('Copy failed:', error);
                addButtonFeedback(event.target, 'error');
                showNotification('Failed to copy', 'error');
            } finally {
                const button = event.target;
                button.disabled = false;
                button.classList.remove('loading');
            }
        }

        // Enhanced form management
        function clearFormFields() {
            try {
                const fields = ['tech-name', 'store-number', 'work-order', 'notes', 'dropdown-notes'];
                fields.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.value = '';
                });
                
                const dropdownNotes = document.getElementById('dropdown-notes');
                if (dropdownNotes) dropdownNotes.dataset.userEdited = 'false';
                
                const selects = ['autofill', 'history'];
                selects.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.selectedIndex = 0;
                        element.value = '';
                    }
                });
                
                showNotification('Form cleared', 'success', 1500);
                clearAutoSave();
                
            } catch (error) {
                console.error('Failed to clear form:', error);
                showNotification('Failed to clear form', 'error');
            }
        }

        function clearForm() {
            if (!confirm('This will clear all form data AND delete all saved history. Are you sure?')) {
                return;
            }
            
            try {
                clearFormFields();
                localStorage.removeItem('notesHistory');
                updateHistoryDropdown();
                showNotification('Everything cleared', 'success');
            } catch (error) {
                console.error('Failed to clear everything:', error);
                showNotification('Failed to clear everything', 'error');
            }
        }

        // Auto-save functionality
        function scheduleAutoSave() {
            clearTimeout(AppState.autoSaveTimer);
            AppState.autoSaveTimer = setTimeout(() => {
                const currentData = JSON.stringify(getFormData());
                if (currentData !== AppState.lastSavedData && hasValidData(getFormData())) {
                    saveNotesHistory();
                    AppState.lastSavedData = currentData;
                }
            }, 30000); // Auto-save after 30 seconds of inactivity
        }

        function clearAutoSave() {
            clearTimeout(AppState.autoSaveTimer);
            AppState.lastSavedData = null;
        }

        // Enhanced input validation
        function setupInputValidation() {
            const storeNumberInput = document.getElementById('store-number');
            if (storeNumberInput) {
                storeNumberInput.addEventListener('input', function(e) {
                    const value = e.target.value;
                    if (value && !/^\d+$/.test(value)) {
                        // Optionally, you can set a custom validity message here
                        // e.target.setCustomValidity('Please enter only numbers.');
                    } else {
                        e.target.setCustomValidity('');
                    }
                });
            }
            // Add auto-save only to specific text inputs and textareas (not selects)
            const formInputs = [
                document.getElementById('tech-name'),
                document.getElementById('store-number'),
                document.getElementById('work-order'),
                document.getElementById('notes'),
                document.getElementById('dropdown-notes')
            ].filter(Boolean);
            formInputs.forEach(input => {
                input.addEventListener('input', scheduleAutoSave);
            });
        }

        // Keyboard navigation enhancements
        function setupKeyboardNavigation() {
            // Theme toggle with keyboard
            document.addEventListener('keydown', function(e) {
                if (e.key === 'F2') {
                    e.preventDefault();
                    toggleTheme();
                }
                
                // Quick copy with Ctrl+Shift+C
                if (e.ctrlKey && e.shiftKey && e.key === 'C') {
                    e.preventDefault();
                    copyAdditionalNotes();
                }
            });
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Set theme from localStorage
                const savedTheme = localStorage.getItem('theme');
                const isDark = savedTheme === 'dark';
                
                document.body.classList.remove('light-mode', 'dark-mode');
                document.body.classList.add(isDark ? 'dark-mode' : 'light-mode');
                updateThemeIcon(isDark);
                
                // Update theme button aria-label
                const themeButton = document.getElementById('theme-toggle-btn');
                if (themeButton) {
                    themeButton.setAttribute('aria-label', 
                        isDark ? 'Switch to light mode' : 'Switch to dark mode'
                    );
                }

                // Update history dropdown
                updateHistoryDropdown();

                // Setup enhanced functionality
                setupInputValidation();
                setupKeyboardNavigation();

                // Track user edits on dropdown-notes
                const dropdownNotes = document.getElementById('dropdown-notes');
                if (dropdownNotes) {
                    dropdownNotes.addEventListener('input', function() {
                        this.dataset.userEdited = 'true';
                    });
                }

                // Initialize auto-save state
                AppState.lastSavedData = JSON.stringify(getFormData());
                
                console.log('QA Checklist App initialized successfully');
                
            } catch (error) {
                console.error('Initialization failed:', error);
                showNotification('App initialization failed', 'error');
            }
        });

        // Add notification container for accessibility
        document.addEventListener('DOMContentLoaded', function() {
            const notificationContainer = document.createElement('div');
            notificationContainer.setAttribute('aria-live', 'polite');
            notificationContainer.setAttribute('aria-atomic', 'true');
            notificationContainer.className = 'sr-only';
            notificationContainer.id = 'notification-announcer';
            document.body.appendChild(notificationContainer);
        });
    </script>
